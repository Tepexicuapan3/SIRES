{% extends './menu.html' %}
{% block title %}Autorizadores{% endblock %}
{% block customCSS %}
{% endblock %}
<style>
    .fa-bars,
    .fa-xmark {
        transition: transform 0.5s ease;
        /* Ajusta el tiempo de la transición aquí */
    }

    /* Pantallas grandes */
    @media (min-width: 576px) {
        .d-block {
            display: block !important;
        }

        .d-sm-none {
            display: none !important;
        }
    }

    /* Pantallas pequeñas */
    @media (max-width: 575.98px) {
        .d-block {
            display: none !important;
        }

        .d-sm-none {
            display: block !important;
        }
    }
</style>
{% block contenido %}
{% include 'mensajes.html' %}
    <div class="page-header pt-3 stc">
        <h3 id="nom_rep">CATÁLOGO DE AUTORIZADORES</h3> <!-- Texto debajo del boton menu -->
    </div>
    <p class="lead stc" style="font-size: 75%;">Este catálogo está diseñado para centralizar información sobre los
        autorizadores de las clínicas correspondientes facilitando la gestión y referencia de pacientes, así como la
        coordinación de servicios médicos.
    </p>
    <hr> <!-- linea gris delgada denajo del texto-->
    <div class="container py-4 stc">
        <div class="row justify-content-center">
            <div class="col-lg-12">
                <!--Card-->
                <div class="card text-bg-secondary bg-opacity-10" style="font-size: small;">
                    <div class="card-header text-dark">
                        Realice las acciones necesarias en el siguiente catálogo.
                    </div>
                    <!--Card body-->
                    <div class="card-body">
                        <!-- Form inputs within a row -->
                        <form name="formulario" id="miFormulario" action="{{ url_for('catalogos.cat_autorizadores') }}" method="post">
                            {{ form.hidden_tag() }}
                            <div class="new-registro" style="display: none;">
                                <div class="row mb-4">
                                    <div class="col-1">
                                        <div class="form-outline mdb-input">
                                            {{ form.txtId(class="form-control form-control-sm input-form input_readonly", id="txtId") }}
                                            <label class="form-label" for="txtId">{{ form.txtId.label }}</label>
                                        </div>
                                    </div>
                                </div>
                                <br>
                            </div>  
                            <div class="row mb-4 ">
                                <div class="col-2">
                                    <div class="form-outline mdb-input">
                                        {{ form.txtCve(class="form-control form-control-sm input-form", id="txtCve", autocomplete="off", list="clinicasLista") }}
                                        <label class="form-label" for="txtCve">{{ form.txtCve.label }}</label>
                                        <datalist id="clinicasLista"></datalist>
                                    </div>
                                </div>
                                <!-- Last name input -->
                                <div class="col-4">
                                    <div class="form-outline mdb-input">
                                        {{ form.txtAutorizador(class="form-control form-control-sm input-form", id="txtAutorizador") }}
                                        <label class="form-label" for="txtAutorizador">{{ form.txtAutorizador.label }}</label>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="form-outline mdb-input">
                                        {{ form.txtCargo(class="form-control form-control-sm input-form", id="txtCargo") }}
                                        <label class="form-label" for="txtCargo">{{ form.txtCargo.label }}</label>
                                    </div>
                                </div>
                                {{ form.txtIdTpAutorizador(class=" input-form", id="txtIdTpAutorizador") }}
                                <div class="col-2">
                                    <div class="form-outline mdb-input">
                                        {{ form.txtTpAutorizador(class="form-control form-control-sm input-form", id="txtTpAutorizador", autocomplete="off", list="tpautorizadoresLista") }}
                                        <label class="form-label" for="txtTpAutorizador">{{ form.txtTpAutorizador.label }}</label>
                                        <datalist id="tpautorizadoresLista"></datalist>
                                    </div>
                                </div>
                            </div>
                            <br>
                            <div class="row mb-4">
                                <!-- First name input -->
                                <div class="col-4">
                                    <div class="form-outline mdb-input">
                                        {{ form.txtImgFirma(class="form-control form-control-sm input-form", id="txtImgFirma") }}
                                        <label class="form-label" for="txtImgFirma">{{ form.txtImgFirma.label }}</label>
                                    </div>
                                </div>
                                <div class="col-3">
                                    <div class="form-outline mdb-input">
                                        {{ form.txtPwdAutorizador(class="form-control form-control-sm input-form", id="txtPwdAutorizador") }}
                                        <label class="form-label" for="txtPwdAutorizador">{{ form.txtPwdAutorizador.label }}</label>
                                    </div>
                                </div>
                                <div class="col-5">
                                    <div class="form-outline mdb-input">
                                        {{ form.txtUsuario(class="form-control form-control-sm input-form", id="txtUsuario", autocomplete="off", list="usuariosLista") }}
                                        <label class="form-label" for="txtUsuario">{{ form.txtUsuario.label }}</label>
                                        <datalist id="usuariosLista"></datalist>
                                    </div>
                                </div>
                            </div>                                                  
                            {{ form.opcion(id="opcion", class="input-form") }}
                        </form>
                        <br>
                        <div class="row mb-4">
                            <div class="col-md-12 d-flex justify-content-center">
                                <table>
                                    <tr>
                                        <th class="registro">
                                            <button name="boton" type="button" onclick="enviarFormulario(153)"
                                                title="Registrar" class="btn btn-success btn-rounded">
                                                <i class="bi bi-upload"></i>
                                                <span class="d-none d-sm-inline">Registrar</span>
                                            </button>
                                        </th>
                                        <th class="modificacion" style="display: none; margin-right: 2.5px;">
                                            <button name="boton" type="button" onclick="enviarFormulario(154)"
                                                title="Modificar" class="btn btn-warning btn-rounded">
                                                <i class="bi bi-pencil-square"></i>
                                                <span class="d-none d-sm-inline">Modificar</span>
                                            </button>
                                            <button name="boton" type="button" onclick="enviarFormulario(155)"
                                                title="Cambiar Estatus" class="btn btn-info btn-rounded">
                                                <i class="bi bi-pencil-square"></i>
                                                <span class="d-none d-sm-inline">Desactivar</span>
                                            </button>
                                        </th>
                                        <th class="mod_estatus" style="display: none; margin-right: 2.5px;">
                                            <button name="boton" type="button" onclick="enviarFormulario(155)"
                                                title="Cambiar Estatus" class="btn btn-info btn-rounded">
                                                <i class="bi bi-pencil-square"></i>
                                                <span class="d-none d-sm-inline">Activar</span>
                                            </button>
                                        </th>
                                        <th>
                                            <button type="button" title="Limpiar" value="Limpiar"
                                                class="btn btn-dark btn-rounded" onclick="limpiarFormulario()">
                                                <i class="bi bi-backspace-reverse"></i>
                                                <span class="d-none d-sm-inline">Limpiar</span>
                                            </button>
                                        </th>
                                    </tr>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!--Input de Busqueda y boton imprimir-->
    <form name="formulario" id="formImpresion" action="{{ url_for('catalogos.reporte_nuevo') }}" method="post">
        <div class="row d-flex justify-content-center p-3 stc">
            <div class="col-3"></div>
            <div class="col-3" style="text-align: center;">
                <div data-mdb-input-init class="form-outline">
                    <input type="text" id="busqueda" name="busqueda" class="form-control form-control-sm"
                        style="background-color: white;" />
                    <label class="form-label" for="busqueda">Buscar</label>
                </div>
            </div>
            <div class="col-4" style="text-align: left;">
                <!-- Agregar un campo oculto para el número de catálogo -->
                <input type="hidden" id="cat" name="cat" value="autorizadores">
                <button type="button" title="Imprimir" class="btn btn-primary btn-sm btn-rounded" onclick="imprimir()">
                    <i class="bi bi-printer-fill"></i>
                    <span class="d-none d-sm-inline">Imprimir</span>
                </button>
            </div>
        </div>
    </form>

    <!--Tabla-->
    <div class="row d-flex justify-content-center p-3 stc">
        <div class="text-center" style="position: relative; width: 90%;">
            <div class="table-responsive" style="height: 300px;">
                <!-- Contenido de la tabla aquí -->
                {% if autorizadores %}
                <table id="titulo" class="table table-hover fonthead table-bordered table-sm"
                    style="width: 100%; border-collapse: separate; border-spacing: 0;">
                    <thead class="table-dark">
                        <tr id="encabezado">
                            <th class="no-visible">REGISTRO</th>
                            <th class="visible">CLAVE CLÍNICA</th>
                            <th class="visible">CLÍNICA</th>
                            <th class="visible">AUTORIZADOR</th>
                            <th class="visible">CARGO</th>
                            <th class="visible">ID TPAUTORIZADOR</th>
                            <th class="visible">TIPO DE AUTORIZADOR</th>
                            <th class="visible">AUTORIZADOR</th>
                            <th class="visible">IMAGEN FIRMA</th>
                            <th class="visible">PASSWORD AUTORIZADOR</th>
                            <th class="visible">ID USUARIO</th>
                            <th class="visible">USUARIO</th>
                            <th class="visible">ESTATUS</th>
                        </tr>
                    </thead>
                    <tbody id="datos" style="font-size: 80%;">
                        {% for autorizador, clinica, expediente, nombres, apellidoPaterno, apellidoMaterno in autorizadores %}
                        <tr id="{{ autorizador.id_autorizador }}">
                            <td name="txtId" class="no-visible text-center input-form">{{ autorizador.id_autorizador }}</td>
                            <td name="txtCve" class="visible texto-largo input-form">{{ autorizador.id_clin }}</td>
                            <td name="txtClinica" class="visible texto-largo input-form">{{ autorizador.clinica }}</td>
                            <td name="txtAutorizador" class="visible texto-largo input-form">{{ autorizador.autorizador }}</td>
                            <td name="txtCargo" class="visible texto-largo input-form">{{ autorizador.cargo }}</td>
                            <td name="txtIdTpAutorizador" class="visible texto-largo input-form">{{ autorizador.id_tpautorizador }}</td>
                            <td name="txtTpAutorizador" class="no-visible text-center input-form">{{ autorizador.tpautorizador }}</td>
                            <td name="txtImgFirma" class="visible texto-largo input-form">{{ autorizador.img_firma }}</td>
                            <td name="txtPwdAutorizador" class="visible texto-largo input-form">{{ autorizador.pwd_autorizador }}</td>
                            <td name="txtIdUser" class="visible texto-largo input-form">{{ autorizador.id_usuario }}</td>
                            <td name="txtUsuario" class="visible texto-largo input-form">{{ '{}: {}'.format(id_clin, clinica) }}</td>
                            <td name="txtEstatus" class="visible texto-largo {% if medicoclin.est_medclin == 'A' %}table-success{% elif medicoclin.est_medclin == 'B' %}table-danger{% endif %}">
                                {% if autorizador.est_autorizador == 'A' %}
                                    ACTIVO
                                {% elif autorizador.est_autorizador == 'B' %}
                                    INACTIVO
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            {% else %}
                <center>
                    <h3 class="text-center metro" style="color:#970000;">
                        <b> NO <span style="padding-left:40px;"> </span> HAY <span style="padding-left:40px;"> </span> REGISTROS </b>
                    </h3>
                </center>
            {% endif %}
            </div>
        </div>
    </div>
    
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <script>
        $(document).ready(function() {
            $('#txtUsuario').on('input', function() {
                var query = $(this).val(); // Obtiene el valor ingresado
                buscarUsuario(query);
            });
        });

        function buscarUsuario(query) {
            $.ajax({
                url: "{{ url_for('catalogos.buscar_usuario') }}",
                type: "GET",
                data: { query: query },
                dataType: "json",
                success: function(data) {
                    var datalist = $('#usuariosLista');
                    datalist.empty();  // Limpia las opciones actuales

                    // Almacena los resultados en el campo de entrada para su posterior uso
                    $('#txtUsuario').data('usuarios', data);
                    
                    // Llena el datalist con las opciones encontradas
                    data.forEach(function(usuario) {
                        var option = $('<option></option>').val(usuario.usuario);
                        datalist.append(option);
                    });
                }
            });
        }

        $(document).ready(function() {
            $('#txtTpAutorizador').on('input', function() {
                var query = $(this).val(); // Obtiene el valor ingresado
                buscarTpAutorizador(query);
            });
        });

        function buscarTpAutorizador(query) {
            $.ajax({
                url: "{{ url_for('catalogos.buscar_tpautorizador') }}",
                type: "GET",
                data: { query: query },
                dataType: "json",
                success: function(data) {
                    var datalist = $('#tpautorizadoresLista');
                    datalist.empty();  // Limpia las opciones actuales

                    // Almacena los resultados en el campo de entrada para su posterior uso
                    $('#txtTpAutorizador').data('tpautorizador', data);
                    
                    // Llena el datalist con las opciones encontradas
                    data.forEach(function(tpautorizador) {
                        var option = $('<option></option>').val(tpautorizador.tpautorizador);
                        datalist.append(option);
                    });

                    if (data.length == 1 && query.toUpperCase() == data[0].tpautorizador.toUpperCase()) {
                        var tpautorizador = data[0];
                        $('#txtIdTpAutorizador').val(tpautorizador.id);
                    } else {
                        // Si hay más de un usuario, limpia los campos
                        $('#txtIdTpAutorizador').val('');
                    }
                }
            });
        }

        $(document).ready(function() {
            $('#txtCve').on('input', function() {
                var query = $(this).val(); // Obtiene el valor ingresado
                buscarClinica(query);
            });
        });

        function buscarClinica(query) {
            $.ajax({
                url: "{{ url_for('catalogos.buscar_clinica') }}",
                type: "GET",
                data: { query: query },
                dataType: "json",
                success: function(data) {
                    var datalist = $('#clinicasLista');
                    datalist.empty();  // Limpia las opciones actuales

                    // Almacena los resultados en el campo de entrada para su posterior uso
                    $('#txtCve').data('clinicas', data);
                    
                    // Llena el datalist con las opciones encontradas
                    data.forEach(function(clinica) {
                        var option = $('<option></option>').val(clinica.clinica);
                        datalist.append(option);
                    });

                    if (data.length == 1 && query.toUpperCase() == data[0].clinica.toUpperCase()) {
                        var clinica = data[0];
                        $('#txtClinica').val(clinica.id);
                    } else {
                        // Si hay más dse un usuario, limpia los campos
                        $('#txtClinica').val('');
                    }
                }
            });
        }
    </script>
    <script src="{{ url_for ('static', filename='js/catalogos.js') }}"></script>
{% endblock %}