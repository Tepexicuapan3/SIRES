{% extends './menu.html' %}
{% block title %}Laboratorios{% endblock %}
{% block customCSS %}
{% endblock %}
<style>
    .fa-bars,
    .fa-xmark {
        transition: transform 0.5s ease;
        /* Ajusta el tiempo de la transición aquí */
    }

    /* Pantallas grandes */
    @media (min-width: 576px) {
        .d-block {
            display: block !important;
        }

        .d-sm-none {
            display: none !important;
        }
    }

    /* Pantallas pequeñas */
    @media (max-width: 575.98px) {
        .d-block {
            display: none !important;
        }

        .d-sm-none {
            display: block !important;
        }
    }
</style>
{% block contenido %}
{% include 'mensajes.html' %}
    <div class="page-header pt-3 stc">
        <h3 id="nom_rep">CATÁLOGO DE LABORATORIOS</h3>
    </div>
    <p class="lead stc" style="font-size: 75%;">
        Este catálogo está enfocado en gestionar y organizar los laboratorios del sistema de salud.
    </p>
    <hr>
    <div class="container py-5 stc">
        <div class="row justify-content-center">
            <div class="col-lg-12">
                <!-- Card -->
                <div class="card text-bg-secondary bg-opacity-10" style="font-size: small;">
                    <div class="card-header text-dark">
                        Realice las acciones necesarias en el siguiente catálogo. 
                    </div>
                    <!-- Card body -->
                    <div class="card-body">
                        <!-- Form inputs within a row -->
                        <form name="formulario" id="miFormulario" action="{{url_for('catalogos.cat_laboratorios')}}" method="post">
                            {{ form.hidden_tag() }}
                            <div class="row mb-4 justify-content-center">
                                <!-- First name input -->
                                <div class="new-registro" style="display: none;">
                                    <div class="row mb-4">
                                        <div class="col-2">
                                            <div class="form-outline mdb-input">
                                                {{ form.txtId(class="form-control form-control-sm input-form input_readonly", id="txtId") }}
                                                <label class="form-label" for="txtId">{{ form.txtId.label }}</label>
                                            </div>
                                        </div>
                                    </div>
                                    <br>
                                </div>
                                <div class="col-7">
                                    <div class="form-outline mdb-input">
                                        {{ form.txtLaboratorio(class="form-control form-control-sm input-form", id="txtLaboratorio") }}
                                        <label class="form-label" for="txtLaboratorio">{{ form.txtLaboratorio.label }}</label>
                                    </div>
                                </div>
                                <div class="col-5">
                                    <div class="form-outline mdb-input">
                                        {{ form.txtUnidadLab(class="form-control form-control-sm input-form", id="txtUnidadLab") }}
                                        <label class="form-label" for="txtUnidadLab">{{ form.txtUnidadLab.label }}</label>
                                    </div>
                                </div>
                            </div>
                            <br>
                            <div class="row mb-4 justify-content-center">
                                <div class="col-3">
                                    <div class="form-outline mdb-input">
                                        {{ form.txtEntidadFed(class="form-control form-control-sm input-form", id="txtEntidadFed") }}
                                        <label class="form-label" for="txtEntidadFed">{{ form.txtEntidadFed.label }}</label>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="form-outline mdb-input">
                                        {{ form.txtMunicipio(class="form-control form-control-sm input-form", id="txtMunicipio") }}
                                        <label class="form-label" for="txtMunicipio">{{ form.txtMunicipio.label }}</label>
                                    </div>
                                </div>
                                <div class="col-5">
                                    <div class="form-outline mdb-input">
                                        {{ form.txtAsenta(class="form-control form-control-sm input-form", id="txtAsenta", list="listAsenta", autocomplete="off") }}
                                        <label class="form-label" for="txtAsenta">{{ form.txtAsenta.label }}</label>
                                        <datalist id="listAsenta"></datalist>
                                    </div>
                                </div>
                            </div>
                            <br>
                            <div class="row mb-4">
                                <div class="col-2">
                                    <div class="form-outline mdb-input">
                                        {{ form.txtCp(class="form-control form-control-sm input-form", id="txtCp") }}
                                        <label class="form-label" for="txtCp">{{ form.txtCp.label }}</label>
                                    </div>
                                </div>
                                <div class="col-5">
                                    <div class="form-outline mdb-input">
                                        {{ form.txtCalle(class="form-control form-control-sm input-form", id="txtCalle") }}
                                        <label class="form-label" for="txtCalle">{{ form.txtCalle.label }}</label>
                                    </div>
                                </div>
                                <div class="col-5">
                                    <div class="form-outline mdb-input">
                                        {{ form.txtTelefono(class="form-control form-control-sm input-form", id="txtTelefono", placeholder="Ej. 55360763 EXT. 6052") }}
                                        <label class="form-label" for="txtTelefono">{{ form.txtTelefono.label }}</label>
                                    </div>
                                </div>
                                {{ form.opcion(id="opcion", class="input-form") }}
                            </div>
                        </form>
                        <br>
                        <div class="row">
                            <div class="col-md-12 d-flex justify-content-center">
                                <table>
                                    <tr>
                                        <th class="registro">
                                            <button name="boton" type="button" onclick="enviarFormulario(153)" title="Registrar" class="btn btn-success btn-rounded">
                                                <i class="bi bi-upload"></i>
                                                <span class="d-none d-sm-inline">Registrar</span>
                                            </button>
                                        </th>
                                        <th class="modificacion" style="display: none; margin-right: 2.5px;">
                                            <button name="boton" type="button" onclick="enviarFormulario(154)" title="Modificar" class="btn btn-warning btn-rounded">
                                                <i class="bi bi-pencil-square"></i>
                                                <span class="d-none d-sm-inline">Modificar</span>
                                            </button>
                                            <button name="boton" type="button" onclick="enviarFormulario(155)" title="Cambiar Estatus" class="btn btn-info btn-rounded">
                                                <i class="bi bi-pencil-square"></i>
                                                <span class="d-none d-sm-inline">Desactivar</span>
                                            </button>
                                        </th>
                                        <th class="mod_estatus" style="display: none; margin-right: 2.5px;">
                                            <button name="boton" type="button" onclick="enviarFormulario(155)" title="Cambiar Estatus" class="btn btn-info btn-rounded">
                                                <i class="bi bi-pencil-square"></i>
                                                <span class="d-none d-sm-inline">Activar</span>
                                            </button>
                                        </th>
                                        <th>
                                            <button type="button" title="Limpiar" value="Limpiar" class="btn btn-dark btn-rounded" onclick="limpiarFormulario()">
                                                <i class="bi bi-backspace-reverse"></i>
                                                <span class="d-none d-sm-inline">Limpiar</span>
                                            </button>
                                        </th>
                                    </tr>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!--Input de Busqueda y boton imprimir-->
    <form name="formulario" id="formImpresion" action="{{url_for('catalogos.reporte_nuevo')}}" method="post">
        <div class="row d-flex justify-content-center p-3 stc">
            <div class="col-3"></div>
            <div class="col-3" style="text-align: center;">
                <div data-mdb-input-init class="form-outline">
                    <input type="text" id="busqueda" name="busqueda" class="form-control form-control-sm" style="background-color: white;"/>
                    <label class="form-label" for="busqueda">Buscar</label>
                </div>
            </div>
            <div class="col-4" style="text-align: left;">
                <!-- Agregar un campo oculto para el número de catálogo -->
                <input type="hidden" id="cat" name="cat" value="laboratorios">
                <button type="button" title="Imprimir" class="btn btn-primary btn-sm btn-rounded" onclick="imprimir()">
                    <i class="bi bi-printer-fill"></i>
                    <span class="d-none d-sm-inline">Imprimir</span>
                </button>
            </div>
        </div> 
    </form>

    <!--Tabla-->
    <div class="row d-flex justify-content-center p-3 stc">
        <div class="text-center" style="position: relative; width: 90%;">
            <div class="table-responsive" style="height: 300px;">
                <!-- Contenido de la tabla aquí -->
                {% if laboratorios %}
                <table id="titulo" class="table table-hover fonthead table-bordered table-sm" style="width: 100%; border-collapse: separate; border-spacing: 0;">
                    <thead class="table-dark">
                        <tr id="encabezado">
                            <th class="no-visible">REGISTRO</th>
                            <th class="visible">LABORATORIO</th>
                            <th class="visible">UNIDAD</th>
                            <th class="visible" style = "width: 35%">DIRECCIÓN</th>
                            <th class="no-visible">CALLE</th>
                            <th class="no-visible">ASENTAMIENTO</th>
                            <th class="no-visible">CP</th>
                            <th class="no-visible">MUNICIPIO</th>
                            <th class="no-visible">ENTIDAD FEDERATIVA</th>
                            <th class="visible">TELÉFONO</th>
                            <th class="visible" style="width: 12%">ESTATUS</th>
                        </tr>
                    </thead>
                    <tbody id="datos" style="font-size: 80%;">
                        {% for lab in laboratorios %}
                        <tr id="{{ lab.id_lab }}">
                            <td name="txtId" class="no-visible text-center input-form">{{ lab.id_lab }}</td>
                            <td name="txtLaboratorio" class="visible texto-largo input-form">{{ lab.laboratorio }}</td>
                            <td name="txtUnidadLab" class="visible texto-largo input-form">{{ lab.unidad_lab }}</td>
                            <td class="visible texto-largo">{{ '{}, {}, {}, C.P. {}, {}'.format (lab.calle, lab.asenta, lab.municipio, lab.cp, lab.entidad_fed) }}</td>
                            <td name="txtCalle" class="no-visible texto-largo input-form">{{ lab.calle }}</td>
                            <td name="txtAsenta" class="no-visible texto-largo input-form">{{ lab.asenta }}</td>
                            <td name="txtCp" class="no-visible texto-largo input-form">{{ lab.cp }}</td>
                            <td name="txtMunicipio" class="no-visible texto-largo input-form">{{ lab.municipio }}</td>
                            <td name="txtEntidadFed" class="no-visible texto-largo input-form">{{ lab.entidad_fed }}</td>
                            <td name="txtTelefono" class="visible texto-largo input-form">{{ lab.telefono }}</td>
                            <td name="txtEstatus" class="visible texto-largo {% if lab.est_lab == 'A' %}table-success{% elif lab.est_lab == 'B' %}table-danger{% endif %}">
                                {% if lab.est_lab == 'A' %}
                                    ACTIVO
                                {% elif lab.est_lab == 'B' %}
                                    INACTIVO
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                    <center>
                        <h3 class="text-center metro" style="color:#970000;">
                            <b> NO <span style="padding-left:40px;"> </span> HAY <span style="padding-left:40px;"> </span> REGISTROS </b>
                        </h3>
                    </center>
                {% endif %}
            </div>
        </div>
    </div>
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <script src="{{ url_for ('static', filename='js/catalogos.js') }}"></script>
    <script>
        const selectEntidadFed = document.getElementById('txtEntidadFed');
        selectEntidadFed.value = 'CIUDAD DE MÉXICO';
        const selectMunicipio = document.getElementById('txtMunicipio');
        const inputAsenta = document.getElementById('txtAsenta');
        const listAsenta = document.getElementById('listAsenta');
        const selectCp = document.getElementById('txtCp');
        
        console.time('FetchData');
        let datosEstructuradosCargados  = fetch('/catalogos/api/datos_cp')
            .then(response => response.json())
            .then(datos => {
                datos_estructurados = datos;
                console.timeEnd('FetchData');
            })
            .catch(error => {
                console.error('Failed to fetch data:', error);
                throw error;  // Propaga el error.
            });
        
        iniciarCombox();

        function iniciarCombox() {
            datosEstructuradosCargados.then(() => {
                actualizarMunicipios(selectEntidadFed.value)

                selectEntidadFed.onchange = function() { actualizarMunicipios(selectEntidadFed.value); };
                selectMunicipio.onchange = function() { actualizarAsentamientos(selectEntidadFed.value, selectMunicipio.value); };
                inputAsenta.onchange = function() { actualizarCps(selectEntidadFed.value, selectMunicipio.value, inputAsenta.value); };
            }).catch(error => {
                console.error("Error al iniciar los combobox:", error);
            });
        }

        function actualizarMunicipios(entidad_fed) {
            selectMunicipio.innerHTML = '';
            inputAsenta.value = '';
            listAsenta.innerHTML = ''; 
            selectCp.innerHTML = '';
            selectMunicipio.add(new Option('', '')); 
            selectCp.add(new Option('', ''));

            if (!entidad_fed) { return; }

            const municipios = datos_estructurados[entidad_fed];
            if (Object.keys(municipios).length == 1 ) { selectMunicipio.innerHTML = ''; }
            for (let municipio in municipios) {
                selectMunicipio.add(new Option(municipio, municipio));
            }
            selectMunicipio.dispatchEvent(new Event('change'));
        }

        function actualizarAsentamientos(entidad_fed, municipio) {
            inputAsenta.value = '';
            listAsenta.innerHTML = '';
            selectCp.innerHTML = '';
            selectCp.add(new Option('', ''));
            
            if (!municipio) { return; }

            const asentamientos = datos_estructurados[entidad_fed][municipio];
            if (Object.keys(asentamientos).length == 1 ) { inputAsenta.value = ''; }
            for (let asenta in asentamientos) {
                var option = document.createElement('option');
                option.value = asenta;
                listAsenta.appendChild(option);
            }
            listAsenta.dispatchEvent(new Event('change'));
        }

        function actualizarCps(entidad_fed, municipio, asenta) {
            selectCp.innerHTML = '';
            selectCp.add(new Option('', '')); 

            if (!asenta) { return; }

            const cps = datos_estructurados[entidad_fed][municipio][asenta];
            if (cps.length == 1 ) { selectCp.innerHTML = ''; }
            cps.forEach(cp => {
                const opcion = (new Option(cp, cp));
                selectCp.add(opcion);
            });
        }

        function iniciarComboxCP(entidad_fed, municipio, asenta, cp) {
            datosEstructuradosCargados.then(() => {
                actualizarMunicipios(entidad_fed);
                selectMunicipio.value = municipio;
                if (selectMunicipio.value) {
                    actualizarAsentamientos(entidad_fed, municipio);
                    inputAsenta.value = asenta;
                    if (inputAsenta.value) {
                        actualizarCps(entidad_fed, municipio, asenta);
                        selectCp.value = cp;
                    }
                }
            }).catch(error => {
                console.error("Error al iniciar los combobox:", error);
            });
        }
    </script>
{% endblock %}
